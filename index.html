<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlacierVault | å†°æ„Ÿè²¡å‹™çµ‚ç«¯</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- å¬å–šäº¬è¯è€å®‹é«” --- */
        @font-face {
            font-family: 'JingHua';
            /* é‡è¦ï¼šè«‹ç¢ºä¿å­—é«”æª”æ¡ˆåç‚º font.ttf ä¸¦èˆ‡æ­¤æª”æ¡ˆæ”¾åœ¨ä¸€èµ· */
            src: url('./font.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body { 
            font-family: 'JingHua', 'Noto Sans TC', sans-serif; 
            background-color: #F0F4F8; 
            color: #2D3436; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.6); }
        
        h1, h2, .amount-text { font-family: 'JingHua', serif; font-weight: 900; }

        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex justify-center overflow-hidden select-none">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="w-full max-w-md h-full flex flex-col relative glass border-x shadow-2xl overflow-hidden z-10">
        <div id="loading" class="h-full flex items-center justify-center">
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 border-4 border-[#0095FF] border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-xs font-black tracking-widest text-gray-400 italic">æ­£åœ¨é€£çµå†°æ ¸æ•¸æ“šåº«...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (v12.7.0) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        // --- ğŸ”’ å·²æ¤å…¥æ–° API Keyï¼Œè«‹å‹™å¿…åœ¨ Google Console è¨­å®šé™åˆ¶ ğŸ”’ ---
        const firebaseConfig = {
            apiKey: "AIzaSyCSBhy_xEh4KeXHRed-nvEGR8rda9q00HE",
            authDomain: "icecore-4b374.firebaseapp.com",
            projectId: "icecore-4b374",
            storageBucket: "icecore-4b374.firebasestorage.app",
            messagingSenderId: "565823573872",
            appId: "1:565823573872:web:14037e0b072348f43689b5",
            measurementId: "G-ENV966RJ2L"
        };

        const appId = "glacier-vault-prod";
        const geminiApiKey = ""; // è‹¥éœ€è¦ AI åŠŸèƒ½ï¼Œè«‹åœ¨æ­¤å¡«å…¥ Gemini API Key

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        let state = {
            user: null, transactions: [], categories: ['é£Ÿå“', 'äº¤é€š', 'è³¼ç‰©', 'è–ªè³‡', 'æˆ¿è²¸', 'ä¼‘é–’', 'è¨‚é–±', 'å­¸ç¿’'],
            activeView: 'home', isAdding: false, isSettingBalance: false, isManagingCategories: false,
            editingTx: null, inputNote: '', selectedCategory: 'AI èŠæ­æ–¯', homeFilterCategory: 'å…¨éƒ¨', initialBalance: 0,
            isGeminiLoading: false, currentMonth: new Date(), selectedDay: new Date()
        };

        // --- Firebase ç›£è½å™¨ ---
        function setupListeners() {
            if (!state.user) return;
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), (snap) => {
                if (snap.exists()) state.initialBalance = snap.data().initialBalance || 0;
                render();
            });
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'user_cats'), (snap) => {
                if (snap.exists() && snap.data().list) state.categories = snap.data().list;
                render();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), (snap) => {
                const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                state.transactions = data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            });
        }

        // --- ä»‹é¢æ¸²æŸ“å¼•æ“ ---
        function render() {
            const root = document.getElementById('app');
            if (!state.user) return;

            const incomeTotal = state.transactions.filter(t => t.type === 'æ”¶å…¥').reduce((acc, cur) => acc + (Number(cur.amount) || 0), 0);
            const expenseTotal = state.transactions.filter(t => t.type === 'æ”¯å‡º').reduce((acc, cur) => acc + (Number(cur.amount) || 0), 0);
            const currentBalance = state.initialBalance + incomeTotal - expenseTotal;
            const filteredExpense = state.homeFilterCategory === 'å…¨éƒ¨' ? expenseTotal : state.transactions.filter(t => t.type === 'æ”¯å‡º' && t.category === state.homeFilterCategory).reduce((acc, cur) => acc + (Number(cur.amount) || 0), 0);

            const year = state.currentMonth.getFullYear();
            const month = state.currentMonth.getMonth();
            const calendarDays = [];
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) calendarDays.push(null);
            for (let i = 1; i <= daysInMonth; i++) calendarDays.push(new Date(year, month, i));

            let content = `
                <header class="pt-16 px-8 pb-4 flex-shrink-0 flex justify-between items-end z-10 animate-fade-in">
                    <div>
                        <p class="text-[10px] font-black text-[#0095FF] tracking-[0.3em] mb-1 uppercase italic">GLACIER_VAULT</p>
                        <h1 class="text-3xl font-light tracking-tighter italic text-gray-800 uppercase">${state.activeView === 'home' ? 'è³‡ç”¢æ¦‚è¦½' : state.activeView === 'calendar' ? 'å†’éšªæ›†åƒ' : 'è²¡å‹™åˆ†æ'}</h1>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.toggleManagingCategories(true)" class="p-2 rounded-full glass text-gray-400 hover:bg-white transition-all">ğŸ·ï¸</button>
                        <button onclick="window.toggleSettingBalance(true)" class="p-2 rounded-full glass text-gray-400 hover:bg-white transition-all">âš™ï¸</button>
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto no-scrollbar px-6 pb-40 z-10">
            `;

            if (state.activeView === 'home') {
                content += `
                    <div class="space-y-6 animate-fade-in">
                        <div onclick="window.toggleSettingBalance(true)" class="bg-white/80 rounded-[45px] p-10 shadow-sm border border-white relative overflow-hidden active:scale-95 transition-all">
                            <p class="text-[11px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-2 text-center">æ ¸å¿ƒè³‡ç”¢æ·¨å€¼</p>
                            <h2 class="amount-text text-5xl font-black text-[#0095FF] tracking-tighter text-center">
                                <span class="text-2xl mr-1 font-medium opacity-20 italic">NT$</span>${currentBalance.toLocaleString()}
                            </h2>
                            <div class="mt-10 grid grid-cols-2 gap-4 border-t border-gray-100 pt-8">
                                <div class="bg-[#0095FF]/5 p-4 rounded-[24px] border border-white text-center"><p class="text-[9px] text-gray-400 font-black mb-1 uppercase text-center">ç´¯è¨ˆæ•ç²</p><p class="text-lg font-bold text-green-500 text-center">+${incomeTotal.toLocaleString()}</p></div>
                                <div class="bg-[#0095FF]/5 p-4 rounded-[24px] border border-white ${state.homeFilterCategory !== 'å…¨éƒ¨' ? 'ring-2 ring-[#0095FF]' : ''}"><p class="text-[9px] text-gray-400 font-black mb-1 uppercase text-center">${state.homeFilterCategory === 'å…¨éƒ¨' ? 'æœ¬æœˆæ¶ˆè€—' : state.homeFilterCategory}</p><p class="text-lg font-bold text-gray-700 text-center">-${filteredExpense.toLocaleString()}</p></div>
                            </div>
                        </div>
                        <div class="relative overflow-x-auto no-scrollbar flex space-x-3 pb-2 px-1">
                            ${['å…¨éƒ¨', ...state.categories].map(cat => `<button onclick="window.setHomeFilter('${cat}')" class="px-5 py-2 rounded-full text-[11px] font-black whitespace-nowrap border transition-all ${state.homeFilterCategory === cat ? 'bg-[#0095FF] text-white border-[#0095FF] shadow-lg scale-105' : 'bg-white/60 text-gray-400 border-transparent'}">${cat}</button>`).join('')}
                        </div>
                        <div class="space-y-4">
                            ${state.transactions.filter(t => state.homeFilterCategory === 'å…¨éƒ¨' || t.category === state.homeFilterCategory).map(tx => `
                                <div onclick='window.openEdit(${JSON.stringify(tx).replace(/'/g, "&apos;")})' class="bg-white/80 p-5 rounded-[32px] border border-white flex justify-between items-center shadow-sm cursor-pointer active:scale-98 transition-all hover:bg-white">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-inner border border-gray-50 ${tx.type === 'æ”¶å…¥' ? 'bg-green-50 text-green-500' : 'bg-gray-50 text-gray-400'}">${tx.category === 'è–ªè³‡' ? 'ğŸ’°' : 'ğŸ·ï¸'}</div>
                                        <div><p class="text-[14px] font-black text-gray-800 uppercase">${tx.category}</p><p class="text-[9px] text-gray-400 font-bold italic truncate max-w-[100px]">${tx.note || ''}</p></div>
                                    </div>
                                    <p class="amount-text text-base font-black ${tx.type === 'æ”¶å…¥' ? 'text-green-500' : 'text-gray-800'}">${tx.type === 'æ”¯å‡º' ? '-' : '+'} ${Number(tx.amount).toLocaleString()}</p>
                                </div>
                            `).join('') || '<p class="text-center py-10 text-gray-300 text-xs italic">å°šç„¡æ•¸æ“šå­˜å…¥ ğŸ§Š</p>'}
                        </div>
                    </div>
                `;
            } else if (state.activeView === 'calendar') {
                content += `
                    <div class="space-y-8 animate-fade-in">
                        <div class="bg-white/80 rounded-[40px] p-6 border border-white shadow-lg">
                            <div class="flex justify-between items-center mb-6 px-2">
                                <button onclick="window.changeMonth(-1)" class="p-2 bg-gray-50 rounded-full text-gray-400">â®</button>
                                <h3 class="text-lg font-black text-gray-800 italic">${year}å¹´ ${month + 1}æœˆ</h3>
                                <button onclick="window.changeMonth(1)" class="p-2 bg-gray-50 rounded-full text-gray-400">â¯</button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center mb-2">${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => `<span class="text-[10px] font-black text-gray-300 uppercase">${d}</span>`).join('')}</div>
                            <div class="grid grid-cols-7 gap-1">
                                ${calendarDays.map((date, i) => {
                                    const total = date ? state.transactions.filter(t => t.type === 'æ”¯å‡º' && t.createdAt?.seconds && new Date(t.createdAt.seconds * 1000).toDateString() === date.toDateString()).reduce((acc, cur) => acc + (Number(cur.amount) || 0), 0) : 0;
                                    const isSelected = date && date.toDateString() === state.selectedDay.toDateString();
                                    return `<div onclick="${date ? `window.selectDay('${date.toISOString()}')` : ''}" class="aspect-square rounded-xl flex flex-col items-center justify-center relative cursor-pointer transition-all ${!date ? 'opacity-0' : isSelected ? 'bg-[#0095FF] text-white shadow-lg scale-110' : 'bg-gray-50/50 hover:bg-white text-gray-600'}">${date ? `<span class="text-xs font-bold">${date.getDate()}</span>${total > 0 ? `<span class="text-[7px] font-black mt-1 ${isSelected ? 'text-white' : 'text-[#0095FF]'}">-${total}</span>` : ''}` : ''}</div>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black tracking-[0.2em] text-gray-400 uppercase italic px-2">${state.selectedDay.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' })} æ˜ç´°</h3>
                            ${state.transactions.filter(t => t.createdAt?.seconds && new Date(t.createdAt.seconds * 1000).toDateString() === state.selectedDay.toDateString()).map(tx => `
                                <div onclick='window.openEdit(${JSON.stringify(tx).replace(/'/g, "&apos;")})' class="bg-white/60 p-4 rounded-[24px] border border-white flex justify-between items-center shadow-sm">
                                    <div class="flex items-center space-x-3"><span>ğŸ·ï¸</span><div><p class="text-sm font-bold text-gray-800">${tx.category}</p><p class="text-[8px] text-gray-400">${tx.note || ''}</p></div></div>
                                    <p class="amount-text text-sm font-black ${tx.type === 'æ”¶å…¥' ? 'text-green-500' : 'text-gray-700'}">${tx.type === 'æ”¯å‡º' ? '-' : '+'} ${Number(tx.amount).toLocaleString()}</p>
                                </div>
                            `).join('') || '<p class="text-center py-10 text-gray-300 text-xs italic">ç„¡ç´€éŒ„ ğŸ•¯ï¸</p>'}
                        </div>
                    </div>
                `;
            } else if (state.activeView === 'stats') {
                content += `
                    <div class="bg-white/80 rounded-[40px] p-10 border border-white shadow-lg space-y-10 animate-fade-in">
                        <h3 class="text-[11px] font-black text-gray-400 uppercase tracking-[0.4em] border-b border-gray-50 pb-4 text-center">é¡åˆ¥æ¶ˆè€—ä½”æ¯”</h3>
                        ${Object.entries(state.transactions.filter(t => t.type === 'æ”¯å‡º').reduce((acc, cur) => { acc[cur.category] = (acc[cur.category] || 0) + (Number(cur.amount) || 0); return acc; }, {})).map(([cat, val]) => `
                            <div class="space-y-2">
                                <div class="flex justify-between text-[13px] font-black mb-2 tracking-tight text-gray-600"><span>${cat}</span><span class="amount-text text-[#0095FF]">NT$ ${val.toLocaleString()}</span></div>
                                <div class="h-2 bg-gray-100 rounded-full overflow-hidden shadow-inner"><div class="h-full bg-gradient-to-r from-[#0095FF] to-[#00E0FF] transition-all duration-1000" style="width: ${Math.min((val/(expenseTotal||1))*100, 100)}%"></div></div>
                            </div>
                        `).join('') || '<p class="text-center text-gray-300 text-xs py-10">ç„¡æ•¸æ“š ğŸ§Š</p>'}
                    </div>
                `;
            }

            content += `</main>
                <div class="absolute bottom-10 inset-x-0 flex justify-center z-40 pointer-events-none">
                    <div class="bg-black/90 backdrop-blur-2xl px-10 py-5 rounded-full shadow-2xl flex items-center space-x-10 pointer-events-auto border border-white/10">
                        <button onclick="window.setView('home')" class="p-2 ${state.activeView === 'home' ? 'text-[#0095FF] scale-125' : 'text-gray-500'} transition-all">ğŸ </button>
                        <button onclick="window.setView('calendar')" class="p-2 ${state.activeView === 'calendar' ? 'text-[#0095FF] scale-125' : 'text-gray-500'} transition-all">ğŸ“…</button>
                        <button onclick="window.toggleAdding(true)" class="w-14 h-14 bg-[#0095FF] rounded-full text-white shadow-lg -mt-10 border-4 border-white active:scale-90 transition-all">ï¼‹</button>
                        <button onclick="window.setView('stats')" class="p-2 ${state.activeView === 'stats' ? 'text-[#0095FF] scale-125' : 'text-gray-500'} transition-all">ğŸ“Š</button>
                    </div>
                </div>
            `;

            // Modals (æ–°å¢ã€ç·¨è¼¯ã€è¨­å®š)
            if (state.isAdding) {
                content += `
                    <div class="absolute inset-0 z-[100] bg-black/40 backdrop-blur-md p-8 flex flex-col justify-end animate-fade-in">
                        <div class="absolute inset-0" onclick="window.toggleAdding(false)"></div>
                        <div class="bg-white rounded-[50px] p-10 shadow-2xl border border-white relative animate-slide-up z-10 flex flex-col">
                            <div class="flex justify-between items-center mb-8"><div><h2 class="text-2xl font-black uppercase border-b-4 border-[#0095FF] text-gray-800">æ™ºæ…§å­˜å…¥</h2></div><button onclick="window.toggleAdding(false)" class="text-gray-400">âœ•</button></div>
                            <textarea id="noteInput" class="w-full h-44 bg-gray-50 rounded-[35px] p-8 text-2xl font-light outline-none no-scrollbar shadow-inner focus:ring-2 ring-[#0095FF]/10 transition-all text-gray-800" placeholder="è–ªè³‡ 25W æˆ¿è²¸ 15k..." autofocus></textarea>
                            <button id="submitBtn" onclick="window.submitSmartAdd()" class="w-full mt-10 py-6 rounded-[30px] font-black text-xl bg-[#0095FF] text-white active:scale-95 transition-all">ç¢ºèªå­˜å…¥æŒ‡ä»¤</button>
                        </div>
                    </div>
                `;
            }

            if (state.editingTx) {
                content += `
                    <div class="absolute inset-0 z-[120] bg-black/70 backdrop-blur-md p-8 flex flex-col justify-center animate-fade-in">
                        <div class="absolute inset-0" onclick="window.closeEdit()"></div>
                        <div class="bg-white rounded-[50px] p-10 shadow-2xl border border-white relative animate-slide-up z-10 flex flex-col">
                            <div class="flex justify-between items-center mb-10"><h3 class="text-2xl font-black uppercase border-b-2 border-[#0095FF] text-gray-800">æ•¸æ“šä¿®æ­£</h3><button onclick="window.closeEdit()" class="text-gray-300">âœ•</button></div>
                            <div class="space-y-6">
                                <div><label class="text-[10px] font-black text-gray-400 block mb-2 px-2 uppercase">é‡‘é¡</label><input id="editAmount" type="number" value="${state.editingTx.amount}" class="w-full bg-gray-50 rounded-3xl p-6 text-3xl font-black outline-none shadow-inner text-[#0095FF]" /></div>
                                <div class="flex space-x-4 pt-6">
                                    <button onclick="window.deleteTx()" class="flex-1 py-5 bg-red-50 text-red-500 font-black rounded-3xl active:scale-95 border border-red-100">ç§»é™¤</button>
                                    <button onclick="window.updateTx()" class="flex-2 py-5 bg-[#0095FF] text-white font-black rounded-3xl shadow-xl active:scale-95 px-10">ç¢ºèªåŒæ­¥</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            root.innerHTML = content;
        }

        // --- å…¨åŸŸæ–¹æ³•å¯¦ä½œ ---
        window.setView = (v) => { state.activeView = v; render(); };
        window.toggleAdding = (s) => { state.isAdding = s; render(); };
        window.toggleSettingBalance = (s) => { state.isSettingBalance = s; render(); };
        window.toggleManagingCategories = (s) => { state.isManagingCategories = s; render(); };
        window.setHomeFilter = (cat) => { state.homeFilterCategory = cat; render(); };
        window.changeMonth = (delta) => { state.currentMonth.setMonth(state.currentMonth.getMonth() + delta); render(); };
        window.selectDay = (iso) => { state.selectedDay = new Date(iso); render(); };
        window.openEdit = (tx) => { state.editingTx = tx; render(); };
        window.closeEdit = () => { state.editingTx = null; render(); };

        window.submitBalance = async () => {
            const val = document.getElementById('balanceInput').value;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), { initialBalance: parseAmount(val) }, { merge: true });
            state.isSettingBalance = false;
        };

        window.deleteTx = async () => {
            if (!state.editingTx) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', state.editingTx.id));
            state.editingTx = null;
        };

        window.updateTx = async () => {
            if (!state.editingTx) return;
            const amount = document.getElementById('editAmount').value;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', state.editingTx.id), { amount: Number(amount) });
            state.editingTx = null;
        };

        window.submitSmartAdd = async () => {
            const input = document.getElementById('noteInput').value;
            if (!input.trim() || state.isGeminiLoading) return;
            state.isGeminiLoading = true; render();
            const prompt = `è§£ææ–‡å­—ç‚º JSON é™£åˆ—ï¼š[{"amount": "æ•¸å­—ä¸²", "category": "åˆ†é¡", "type": "æ”¯å‡º"|"æ”¶å…¥", "note": "äº‹ç”±"}]ã€‚è¦å‰‡ï¼šW=è¬, K=åƒã€‚è¼¸å…¥ï¼š${input}`;
            try {
                const raw = await fetchGemini(prompt);
                const results = JSON.parse(raw.replace(/```json|```/g, '').trim());
                const txCol = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                for (const item of results) {
                    await addDoc(txCol, { amount: parseAmount(item.amount), category: item.category || 'å…¶ä»–', type: item.type || 'æ”¯å‡º', note: item.note || input.substring(0, 15), createdAt: serverTimestamp(), uid: state.user.uid });
                }
                state.isAdding = false;
            } catch (e) { console.error(e); }
            finally { state.isGeminiLoading = false; render(); }
        };

        // --- å•Ÿå‹•èˆ‡èº«ä»½ç›£è½ ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                state.user = u;
                setupListeners();
                render();
            } else {
                await signInAnonymously(auth).catch(err => {
                    document.getElementById('loading').innerHTML = `<p class="text-red-400 font-bold">å¯†ç¢¼æ­£ç¢ºï¼Œä½†é–€æ‰“ä¸é–‹ï¼Œè«‹æª¢æŸ¥ç¶²åŸŸé™åˆ¶</p>`;
                });
            }
        });

    </script>
</body>
</html>